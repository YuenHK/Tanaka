<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="A Tool for Manage Record.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>Tanaka</title>

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="images/android-desktop.png">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Material Design Lite">
    <link rel="apple-touch-icon-precomposed" href="images/ios-desktop.png">

    <!-- Tile icon for Win8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <link rel="shortcut icon" href="images/favicon.png">

    <!-- SEO: If your mobile URL is different from the desktop URL, add a canonical link to the desktop page https://developers.google.com/webmasters/smartphone-sites/feature-phones -->
    <!--
    <link rel="canonical" href="http://www.example.com/">
    -->

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.cyan-light_blue.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdui/0.4.3/css/mdui.css">
    <link rel="stylesheet" href="styles.css">
    <style>
    #view-source {
      position: fixed;
      display: block;
      right: 0;
      bottom: 0;
      margin-right: 40px;
      margin-bottom: 40px;
      z-index: 900;
    }
    </style>

  </head>
  <body>
    
    <div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-drawer mdl-layout--fixed-header ">
      <header class="demo-header mdl-layout__header mdl-color--grey-100 mdl-color-text--grey-600">
        <div class="mdl-layout__header-row">
          <span class="mdl-layout-title">Tanaka</span>
          <div class="mdl-layout-spacer"></div>
          <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" id="hdrbtn">
            <i class="material-icons">more_vert</i>
          </button>
          <ul class="mdl-menu mdl-js-menu mdl-js-ripple-effect mdl-menu--bottom-right" for="hdrbtn">
            <li class="mdl-menu__item" onclick='ShowAboutAlert()'>About</li>
          </ul>
        </div>
      </header>
      <div class="demo-drawer mdl-layout__drawer mdl-color--blue-grey-900 mdl-color-text--blue-grey-50">
        <header class="demo-drawer-header">
          <img id="userPhoto" src="images/user.jpg" class="demo-avatar">
          <div class="demo-avatar-dropdown">
            <span id="userEmail">Unknow</span>
            <div class="mdl-layout-spacer"></div>
            <button id="accbtn" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
              <i class="material-icons" role="presentation">arrow_drop_down</i>
              <span class="visuallyhidden">Accounts</span>
            </button>
            <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="accbtn">
              <li class="mdl-menu__item" onclick='logout()'><i class="material-icons">close</i>Logout</li>
            </ul>
          </div>
        </header>
        <nav class="demo-navigation mdl-navigation mdl-color--blue-grey-800">
          <a class="mdl-navigation__link" href="index.html"><i class="mdl-color-text--blue-grey-400 material-icons" role="presentation">home</i>主頁</a>
          <a class="mdl-navigation__link" href="case.html"><i class="mdl-color-text--blue-grey-400 material-icons" role="presentation">inbox</i>紀錄</a>
          <a class="mdl-navigation__link" href="setting.html"><i class="mdl-color-text--blue-grey-400 material-icons" role="presentation">flag</i>設定</a>
          <a class="mdl-navigation__link" href="authority.html"><i class="mdl-color-text--blue-grey-400 material-icons" role="presentation">people</i>權限</a>
          <a class="mdl-navigation__link" href="authority.html"><i class="mdl-color-text--blue-grey-400 material-icons" role="presentation">store</i>庫存</a>
        </nav>
      </div>

      <!-- Top Card -->
      <main class="demo-cards mdl-color--grey-100 ">
        <div class="mdl-grid demo-content">
          <div class="demo-charts mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-grid">
            <div class="demo-updates mdl-card mdl-shadow--2dp mdl-cell mdl-cell--4-col mdl-cell--4-col-tablet mdl-cell--12-col-desktop">
              <div class="mdl-card__title mdl-card--expand mdl-color--teal-300">
                <h2 class="mdl-card__title-text">庫存管理</h2>
              </div>
              <div class="mdl-card__supporting-text mdl-color-text--grey-600">
                你可在本頁刪除&修改&査看全部庫存。
              </div>
            </div>
            <div class="demo-separator mdl-cell--1-col"></div>
          </div>
          
        </div>
      </main>
      <!-- End Top Card -->

      <!-- Add Case -->
      <main class="demo-cards mdl-color--grey-100 ">
        <div class="mdl-grid demo-content">
          <div class="demo-charts mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-grid">

            <form action="#" class="mdui-container mdui-col-xs-12 mdui-col-xs-12 mdui-theme-primary-indigo mdui-theme-accent-pink">

<div class="mdui-container">
  <div class="mdui-textfield">
    <label class="mdui-textfield-label">ID</label>
    <input class="mdui-textfield-input" type="text" name="uid" id="uid"/>
  </div>
  <div class="mdui-textfield">
    <label class="mdui-textfield-label">購買日期</label>
    <input class="mdui-textfield-input" type="date" name="buydate" id="buydate"/>
  </div>
  <div class="mdui-textfield mdui-textfield-floating-label">
    <label class="mdui-textfield-label">內容</label>
    <textarea class="mdui-textfield-input" name="detail" id="detail">處理器 主機板 記憶體 儲存設備 顯示咭</textarea>
  </div>

  <div class="mdui-row-xs-1">
    <div class="mdui-textfield">
      <button type="button" class="mdui-container mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent mdui-col-xs-12" onclick="addCase()">提交</button>    
    </div>
  </div>
</div>

            </form>
            
            <div class="demo-separator mdl-cell--1-col"></div>
          </div>
          
        </div>
      </main>
      <!-- End Add Case -->


      <!-- Item List -->
      <main class="demo-cards mdl-color--grey-100 ">
        <div class="mdl-grid demo-content">
          <div class="mdui-table-hoverable mdui-table-fluid demo-charts mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-grid">
            <table class="mdui-table" id="tableList" name="tableList">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>購買日期</th>
                  <th>維修日期</th>
                  <th>內容</th>
                  <th>狀態</th>
                  <th>編輯</th>
                </tr>
              </thead>
              <tbody name="itemList" id="itemList" >
      
              </tbody>
              </table>
          </div>
        </main>
        <!-- End Item List -->

        <!-- Low Right Button -->
        <button class="mdui-fab mdui-fab-fixed mdui-ripple" onclick="table2excel()"><i class="mdui-icon material-icons">file_download</i></button>

      <!-- About Box -->
      <div class="mdui-container">
        <div class="mdui-dialog" id="Aboutdialog" >
          <div class="mdui-dialog-title">About</div>
          <div class="mdui-dialog-content">Tanaka：維修項目管理工具 @2020</div>
          <div class="mdui-dialog-actions">
            <button type="button" class="mdui-btn mdui-ripple" onclick="window.open('https://github.com/YuenHK')" mdui-dialog-confirm>Github</button>
          </div>
        </div>
      </div>
      <!-- End About Box -->

      <!-- Login Box -->
      <div class="mdui-container">
        <div class="mdui-dialog" id="Logindialog" >
          <div class="mdui-dialog-title">請先使用本校Google帳户登入，再繼續使用</div>
          <div class="mdui-dialog-content">注意並批准彈出視窗，以確保順利登入。如無彈出視窗，按下登入</div>
          <div class="mdui-dialog-actions">
            <button id="LoginBtn" name=" " class="mdui-btn mdui-ripple" onclick='login()' mdui-dialog-confirm>登入</button>
          </div>
        </div>
      </div>
      <!-- End Login Box -->

      <!-- Delete Box-->
      <div class="mdui-container">
        <div class="mdui-dialog" id="deletelog">
          <div class="mdui-dialog-title">編輯庫存</div>
          <div class="mdui-dialog-content" name="ShowDeleteAlertText" id="ShowDeleteAlertText"></div>
          <div class="mdui-dialog-actions">
            <button id="AlertEdit" name=" " class="mdui-btn mdui-ripple" onclick="EditItem(this)" mdui-dialog-confirm>修改</button>
            <button id="AlertDelete" name=" " class="mdui-btn mdui-ripple" onclick="DeleteItem(this)" mdui-dialog-confirm>刪除</button>
            <button class="mdui-btn mdui-ripple" mdui-dialog-cancel>取消</button>
          </div>
        </div>
      </div>
      <!-- End Delete Box-->

    </div>
      
    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mdui/0.4.3/js/mdui.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script src="jquery.table2excel.js"></script>


    <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-firestore.js">
      const firebase = require("firebase");
      require("firebase/firestore");
    </script>

    <script>
    // Web app's Firebase configuration
    firebase.initializeApp({
      apiKey: 'AIzaSyC6PAQwu2C7NuYFFlKnUzMQ-tU2VlkEuGg',
      authDomain: 'tanaka-d99d7.firebaseapp.com',
      projectId: 'tanaka-d99d7'
    });

    var db = firebase.firestore();

    var provider = new firebase.auth.GoogleAuthProvider();
    var profile_displayName;
    var profile_email;
    var profile_photoURL;

    //Login with Google
    login();
    function login(){
      firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        CloseLoginAlert();
        // User is signed in.
        profile_displayName = user.displayName;
        profile_email = user.email;
        profile_photoURL = user.photoURL;

        console.log("Finded a user, Import Profile \n" + profile_displayName + "\n" + profile_email + "\n" + profile_photoURL);
        document.getElementById("userEmail").innerHTML = profile_displayName + "\n" + profile_email;
        document.getElementById("userPhoto").setAttribute("src", user.photoURL);
        ReadCaseList();

      }else {
        ShowLoginAlert();
        firebase.auth().signInWithPopup(provider).then(function(result) {
        // This gives you a Google Access Token. You can use it to access the Google API.
        var token = result.credential.accessToken;
        var user = result.user;
        var name = user.displayName;
        var email = user.email;
        var photoUrl = user.photoURL;
        profile_displayName = user.displayName;
        profile_email = user.email;
        profile_photoURL = user.photoURL;
        console.log("user logined \n" + profile_displayName + "\n" + profile_email + "\n" + profile_photoURL);
      }).catch(function(error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        // The email of the user's account used.
        var email = error.email;
        // The firebase.auth.AuthCredential type that was used.
        var credential = error.credential;
      });};
    });}
    
    //Logout with Google
    function logout(){
    firebase.auth().signOut().then(function() {
      // Sign-out successful.
      profile_displayName = null;
      profile_email = null;
      profile_photoURL = null;
    }).catch(function(error) {
      // An error happened.
      profile_displayName = null;
      profile_email = null;
      profile_photoURL = null;
    });

    }

var instLogin = new mdui.Dialog('#Logindialog');
var instAbout = new mdui.Dialog('#Aboutdialog');
var instDelete = new mdui.Dialog('#deletelog');

// method for Open Delete AlertBox
function ShowDeleteAlert(myObj){
  var html;
  var article = document.querySelector('#'+myObj.id);
  html = "你選擇了【 ID : " + myObj.id + "】;  請按修改或刪除，也可以按取消退出";
  html = html + '<div class="mdui-textfield"><label class="mdui-textfield-label">ID</label><input class="mdui-textfield-input" type="text" name="edit_uid" id="edit_uid" value='+myObj.id+'></div>';
  html = html + '<div class="mdui-textfield"><label class="mdui-textfield-label">購買日期</label><input class="mdui-textfield-input" type="date" name="edit_buydate" id="edit_buydate" value='+article.dataset.buydate+'></div>';
  html = html + '<div class="mdui-textfield"><label class="mdui-textfield-label">維修日期</label><input class="mdui-textfield-input" type="date" name="edit_renewdate" id="edit_renewdate" value='+article.dataset.renewdate+'></div>';
  html = html + '<div class="mdui-textfield"><label class="mdui-textfield-label">內容</label><textarea class="mdui-textfield-input" name="edit_detail" id="edit_detail">'+article.dataset.detail+'</textarea></div>';
  html = html + '<div class="mdui-textfield"><label class="mdui-textfield-label">狀態</label><input class="mdui-textfield-input" type="text" name="edit_state" id="edit_state" value='+article.dataset.state+'></div>';

  document.getElementById("ShowDeleteAlertText").innerHTML = html;
  document.getElementById("AlertDelete").setAttribute("name", myObj.name);
  instDelete.open();
}

// method for Open About AlertBox 
function ShowAboutAlert(){
  instAbout.open();
}

// method for Open Login AlertBox 
function ShowLoginAlert(){
  instLogin.open();
}

// method for Close Login AlertBox 
function CloseLoginAlert(){
  instLogin.close();
}

// event for Login Box 
var Logindialog = document.getElementById('Logindialog');

Logindialog.addEventListener('open.mdui.dialog', function () {
  console.log('open');
});

Logindialog.addEventListener('opened.mdui.dialog', function () {
  console.log('opened');
});

Logindialog.addEventListener('close.mdui.dialog', function () {
  console.log('close');
  firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
      }else {
        ShowLoginAlert();
        login();
        };
    });
});

Logindialog.addEventListener('closed.mdui.dialog', function () {
  console.log('closed');
});

Logindialog.addEventListener('cancel.mdui.dialog', function () {
  console.log('cancel');
});

Logindialog.addEventListener('confirm.mdui.dialog', function () {
  console.log('confirm');
});

// event for AlertDeleteBox 
var deletelog = document.getElementById('deletelog');

deletelog.addEventListener('open.mdui.dialog', function () {
  console.log('open');
});

deletelog.addEventListener('opened.mdui.dialog', function () {
  console.log('opened');
});

deletelog.addEventListener('close.mdui.dialog', function () {
  console.log('close');
});

deletelog.addEventListener('closed.mdui.dialog', function () {
  console.log('closed');
});

deletelog.addEventListener('cancel.mdui.dialog', function () {
  console.log('cancel');
});

deletelog.addEventListener('confirm.mdui.dialog', function () {
  console.log('confirm');
});

//Table to Excel
function table2excel(){
  $("#tableList").table2excel({
    exclude : ".noExl",
    filename : "Record_"  + new Date().getTime()  + ".xls",
    name: "Excel Document Name.xlsx",
    exclude_img: true,
    exclude_links: true,
    exclude_inputs: true
  });
}

// Add Item
function addCase(){
      var inputuid = document.getElementById("uid").value;
      var inputbuydate = document.getElementById("buydate").value;
      var inputdetail = document.getElementById("detail").value;

      if(inputuid.length > 0 && inputbuydate.length > 0 && inputdetail.length > 0){
        db.collection("Store").doc(inputuid).set({
        uid: inputuid, 
        buydate: inputbuydate, 
        renewdate: "",
        detail: inputdetail,
        state: "使用中"
      })
      .then(function(docRef) {
        mdui.snackbar({
          message: '庫存增加成功',
          position: 'bottom',
          timeout: 3000
        });
        ReadCaseList();
      })
      .catch(function(error) {
        console.error("Error adding document: ", error);
        mdui.snackbar({
          message: '庫存增加失敗',
          position: 'bottom',
          timeout: 3000
        });
      });
      } else {
        alert("NULL \(0w0)/")
      }
    };

    //Read Case List to Table
    function ReadCaseList(){
      var ref = db.collection("Store");
      ref.onSnapshot(querySnapshot => {
        var html;
        querySnapshot.forEach(doc => {
          console.log(doc);
          html = html + '<tr><td>' + doc.data().uid + '</td><td>' + doc.data().buydate + '</td><td>' + doc.data().renewdate + '</td><td>' + doc.data().detail + '</td><td>' + doc.data().state + '</td>';
          html = html + '<td>' + '<button id="' + doc.data().uid + '" name="' + doc.data().uid +  '" data-buydate="' + doc.data().buydate + '" data-renewdate="' + doc.data().renewdate + '" data-detail="' + doc.data().detail + '" data-state="' + doc.data().state + '"class=" mdui-icon material-icons mdui-btn mdui-btn-raised mdui-ripple" onclick="ShowDeleteAlert(this)");">&#xe3c9;</button>' + '</td></tr>';
        });
        console.log("ReadCaseList:" + html);
        document.getElementById("itemList").innerHTML = html;
        mdui.mutation();
      });
      
    }

    // ShowDeleteAlertButton_Functiom 刪除項目
    function DeleteItem(myObj){
      var db = firebase.firestore();
      let Ref = db.collection("Store").doc(myObj.name)
      Ref.delete().then(function() {
        console.log('Document successfully deleted!');
        mdui.snackbar({
           message: '庫存刪除成功',
           position: 'bottom',
            timeout: 3000
        });
      }).catch(function(error) {
        console.error('Error removing document: ', error)
        mdui.snackbar({
          message: '庫存刪除失敗',
          position: 'bottom',
          timeout: 3000
      });
    })
      ReadCaseList();
    }

    // Edit_Functiom 修改項目
    function EditItem(myObj){
      var edit_uid = document.getElementById("edit_uid").value;
      var edit_buydate = document.getElementById("edit_buydate").value;
      var edit_renewdate = document.getElementById("edit_renewdate").value;
      var edit_detail = document.getElementById("edit_detail").value;
      var edit_state = document.getElementById("edit_state").value;
      var db = firebase.firestore();
      db.collection("Store").doc(edit_uid).update({
        uid: edit_uid,
        buydate: edit_buydate,
        renewdate: edit_renewdate,
        detail: edit_detail,
        state: edit_state
      })
      .then(function(docRef) {
        console.log("Update Successful");
        mdui.snackbar({
          message: '庫存修改成功',
          position: 'bottom',
          timeout: 3000
        });
        
      })
      .catch(function(error) {
        console.error("Update Fail");
        mdui.snackbar({
          message: '庫存修改失敗',
          position: 'bottom',
          timeout: 3000
        });
      });
      ReadCaseList();
    }

  </script>

  </body>
</html>
