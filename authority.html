<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="A front-end template that helps you build fast, modern mobile web apps.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>Tanaka</title>

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="images/android-desktop.png">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Material Design Lite">
    <link rel="apple-touch-icon-precomposed" href="images/ios-desktop.png">

    <!-- Tile icon for Win8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <link rel="shortcut icon" href="images/favicon.png">

    <!-- SEO: If your mobile URL is different from the desktop URL, add a canonical link to the desktop page https://developers.google.com/webmasters/smartphone-sites/feature-phones -->
    <!--
    <link rel="canonical" href="http://www.example.com/">
    -->

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.cyan-light_blue.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdui/0.4.3/css/mdui.css">
    <link rel="stylesheet" href="styles.css">
    <style>
    #view-source {
      position: fixed;
      display: block;
      right: 0;
      bottom: 0;
      margin-right: 40px;
      margin-bottom: 40px;
      z-index: 900;
    }
    </style>

  </head>
  <body>
    
    <div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-drawer mdl-layout--fixed-header ">
      <header class="demo-header mdl-layout__header mdl-color--grey-100 mdl-color-text--grey-600">
        <div class="mdl-layout__header-row">
          <span class="mdl-layout-title">Tanaka</span>
          <div class="mdl-layout-spacer"></div>
          <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" id="hdrbtn">
            <i class="material-icons">more_vert</i>
          </button>
          <ul class="mdl-menu mdl-js-menu mdl-js-ripple-effect mdl-menu--bottom-right" for="hdrbtn">
            <li class="mdl-menu__item" onclick='ShowAboutAlert()'>About</li>
          </ul>
        </div>
      </header>
      <div class="demo-drawer mdl-layout__drawer mdl-color--blue-grey-900 mdl-color-text--blue-grey-50">
        <header class="demo-drawer-header">
          <img id="userPhoto" src="images/user.jpg" class="demo-avatar">
          <div class="demo-avatar-dropdown">
            <span id="userEmail">Unknow</span>
            <div class="mdl-layout-spacer"></div>
            <button id="accbtn" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
              <i class="material-icons" role="presentation">arrow_drop_down</i>
              <span class="visuallyhidden">Accounts</span>
            </button>
            <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="accbtn">
              <li class="mdl-menu__item" onclick='logout()'><i class="material-icons">close</i>Logout</li>
            </ul>
          </div>
        </header>
        <nav class="demo-navigation mdl-navigation mdl-color--blue-grey-800">
          <a class="mdl-navigation__link" href="index.html"><i class="mdl-color-text--blue-grey-400 material-icons" role="presentation">home</i>主頁</a>
          <a class="mdl-navigation__link" href="case.html"><i class="mdl-color-text--blue-grey-400 material-icons" role="presentation">inbox</i>紀錄</a>
          <a class="mdl-navigation__link" href="setting.html"><i class="mdl-color-text--blue-grey-400 material-icons" role="presentation">flag</i>設定</a>
          <a class="mdl-navigation__link" href="authority.html"><i class="mdl-color-text--blue-grey-400 material-icons" role="presentation">people</i>權限</a>
        </nav>
      </div>

      <!-- Top Card -->
      <main class="demo-cards mdl-color--grey-100 ">
        <div class="mdl-grid demo-content">
          <div class="demo-charts mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-grid">
            <div class="demo-updates mdl-card mdl-shadow--2dp mdl-cell mdl-cell--4-col mdl-cell--4-col-tablet mdl-cell--12-col-desktop">
              <div class="mdl-card__title mdl-card--expand mdl-color--teal-300">
                <h2 class="mdl-card__title-text">管理權限</h2>
              </div>
              <div class="mdl-card__supporting-text mdl-color-text--grey-600">
                你可在本頁增加&刪除具管理員權限的帳户。
              </div>
            </div>
            <div class="demo-separator mdl-cell--1-col"></div>
          </div>
          
        </div>
      </main>
      <!-- End Top Card -->

      <!-- Add Location -->
      <main class="demo-cards mdl-color--grey-100 ">
        <div class="mdl-grid demo-content">
          <div class="demo-charts mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-grid">

            <form action="#" class="mdui-container mdui-col-xs-12 mdui-col-xs-12 mdui-theme-primary-indigo mdui-theme-accent-pink">

              <div class="mdui-textfield">
                <input class="mdui-textfield-input" type="text" placeholder="只允許輸入本校Google帳户     例如： Hello_World@tkpss.edu.hk" name="LocationInput" id="LocationInput" required/>
              </div>

              <button type="button" class="mdui-container mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent mdui-col-xs-12" onclick="addLocation()">增加管理員</button>

            </form>
            
            <div class="demo-separator mdl-cell--1-col"></div>
          </div>
          
        </div>
      </main>
      <!-- End Location -->

      <main class="demo-cards mdl-color--grey-100 ">
        <div class="mdl-grid demo-content">
          <div class="mdui-table-hoverable mdui-table-fluid demo-charts mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-grid">
            <div class="mdui-panel mdui-panel-popout" mdui-panel>
              
              <!-- Item List for Location -->
              <main class="demo-cards mdl-color--grey-100 ">
                <div class="mdl-grid demo-content">
                  <div class="mdui-table-hoverable mdui-table-fluid demo-charts mdl-color--white mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-grid">
                    <table class="mdui-table" >
                      <thead>
                        <tr>
                          <th>管理員帳户</th>
                          <th>刪除</th>
                        </tr">
                      </thead>
                      <tbody name="LocationitemList" id="LocationitemList" >
              
                      </tbody>
                      </table>
                  </div>
                  </main>
                  <!-- End Item List for Location -->
              
            </div>
          </div>
      </main>

      <!-- About Box -->
      <div class="mdui-container">
        <div class="mdui-dialog" id="Aboutdialog" >
          <div class="mdui-dialog-title">About</div>
          <div class="mdui-dialog-content">Tanaka：維修項目管理工具 @2020</div>
          <div class="mdui-dialog-actions">
            <button type="button" class="mdui-btn mdui-ripple" onclick="window.open('https://github.com/YuenHK')" mdui-dialog-confirm>Github</button>
          </div>
        </div>
      </div>
      <!-- End About Box -->

      <!-- Login Box -->
      <div class="mdui-container">
        <div class="mdui-dialog" id="Logindialog" >
          <div class="mdui-dialog-title">請先登入再繼續使用</div>
          <div class="mdui-dialog-content">注意並批准彈出視窗，以確保順利登入。如無彈出視窗，按下登入</div>
          <div class="mdui-dialog-actions">
            <button id="LoginBtn" name=" " class="mdui-btn mdui-ripple" onclick='login()' mdui-dialog-confirm>登入</button>
          </div>
        </div>
      </div>
      <!-- End Login Box -->

      <!-- Delete Box for Location -->
      <div class="mdui-container">
        <div class="mdui-dialog" id="deletelogLocation">
          <div class="mdui-dialog-title">刪除帳户</div>
          <div class="mdui-dialog-content" name="ShowDeleteAlertTextLocation" id="ShowDeleteAlertTextLocation"></div>
          <div class="mdui-dialog-actions">
            <button id="AlertDeleteLocation" name=" " class="mdui-btn mdui-ripple" onclick="DeleteItemLocation(this)" mdui-dialog-confirm>刪除</button>
            <button class="mdui-btn mdui-ripple" mdui-dialog-cancel>取消</button>
          </div>
        </div>
      </div>
      <!-- End Delete Box for Location -->

    </div>
      
    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mdui/0.4.3/js/mdui.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-firestore.js">
      const firebase = require("firebase");
      require("firebase/firestore");
    </script>

    <script>
    // Web app's Firebase configuration
    firebase.initializeApp({
      apiKey: 'AIzaSyC6PAQwu2C7NuYFFlKnUzMQ-tU2VlkEuGg',
      authDomain: 'tanaka-d99d7.firebaseapp.com',
      projectId: 'tanaka-d99d7'
    });

    var db = firebase.firestore();

    var provider = new firebase.auth.GoogleAuthProvider();
    var profile_displayName;
    var profile_email;
    var profile_photoURL;

    //Login with Google
    login();
    function login(){
      firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        CloseLoginAlert();
        // User is signed in.
        profile_displayName = user.displayName;
        profile_email = user.email;
        profile_photoURL = user.photoURL;

        console.log("Finded a user, Import Profile \n" + profile_displayName + "\n" + profile_email + "\n" + profile_photoURL);

        document.getElementById("userEmail").innerHTML = profile_displayName + "\n" + profile_email;
        document.getElementById("userPhoto").setAttribute("src", user.photoURL);

      }else {
        ShowLoginAlert();
        firebase.auth().signInWithPopup(provider).then(function(result) {
        // This gives you a Google Access Token. You can use it to access the Google API.
        var token = result.credential.accessToken;
        var user = result.user;
        var name = user.displayName;
        var email = user.email;
        var photoUrl = user.photoURL;
        profile_displayName = user.displayName;
        profile_email = user.email;
        profile_photoURL = user.photoURL;
        console.log("user logined \n" + profile_displayName + "\n" + profile_email + "\n" + profile_photoURL);
      }).catch(function(error) {
        // Handle Errors here.
        var errorCode = error.code;
        var errorMessage = error.message;
        // The email of the user's account used.
        var email = error.email;
        // The firebase.auth.AuthCredential type that was used.
        var credential = error.credential;
      });};
    });}
    
    //Logout with Google
    function logout(){
    firebase.auth().signOut().then(function() {
      // Sign-out successful.
      profile_displayName = null;
      profile_email = null;
      profile_photoURL = null;
    }).catch(function(error) {
      // An error happened.
      profile_displayName = null;
      profile_email = null;
      profile_photoURL = null;
    });
    }

    // Add Location
    function addLocation(){
      var inputLocation = document.getElementById("LocationInput").value;
      if(inputLocation.length > 0) {
        db.collection("Setting").doc("Authority").collection("Detail").doc(inputLocation).set({
          Email: inputLocation
      })
      .then(function(docRef) {
        console.log("Add Data Successful["+"inputLocation: "+inputLocation+"]");
        mdui.snackbar({
          message: '帳户增加成功',
          position: 'bottom',
          timeout: 3000
        });
        
      })
      .catch(function(error) {
        console.error("Error adding document: ", error);
        mdui.snackbar({
          message: '帳户增加失敗',
          position: 'bottom',
          timeout: 3000
        });
      });
      }
      ReadLocationitemList();
    };

    //Read Location Item List to Table
    ReadLocationitemList();
    function ReadLocationitemList(){
      var html;
      var DeleteButton;
      var ref = db.collection("Setting").doc("Authority").collection("Detail");
      ref.onSnapshot(querySnapshot => {
        querySnapshot.forEach(doc => {
          html = html + '<tr><td>' + doc.data().Email + '</td>';
          DeleteButton = '<td><button id="' + doc.data().Email + '_Delete" name="' + doc.data().Email + '" class=" mdui-icon material-icons mdui-btn mdui-btn-raised mdui-ripple" onclick="ShowDeleteAlertLocation(this)");">&#xe92b;</button></td></tr>'
          html = html = html + DeleteButton;
          console.log(doc.data().Email);
        });
        document.getElementById("LocationitemList").innerHTML = html;
        mdui.mutation();
      });
    }

var instDeleteLocation = new mdui.Dialog('#deletelogLocation');
var instLogin = new mdui.Dialog('#Logindialog');
var instAbout = new mdui.Dialog('#Aboutdialog');

// method for Open About AlertBox 
function ShowAboutAlert(){
  instAbout.open();
}

// method for Open Login AlertBox 
function ShowLoginAlert(){
  instLogin.open();
}

// method for Close Login AlertBox 
function CloseLoginAlert(){
  instLogin.close();
}

// method for Open Delete AlertBox for Location 
function ShowDeleteAlertLocation(myObj){
  document.getElementById("ShowDeleteAlertTextLocation").innerHTML = "你選擇了【 " + myObj.name + " 】。請再次確定刪除，或按取消退出";
  document.getElementById("AlertDeleteLocation").setAttribute("name", myObj.name);
  instDeleteLocation.open();
}

// ShowDeleteAlertButton_Functiom for Location 刪除項目
function DeleteItemLocation(myObj){
  var db = firebase.firestore();
  let Ref = db.collection("Setting").doc("Authority").collection("Detail").doc(myObj.name)
  Ref.delete().then(function() {
      console.log('Document successfully deleted!');
      mdui.snackbar({
          message: '帳户刪除成功',
          position: 'bottom',
          timeout: 3000
      });
  }).catch(function(error) {
      console.error('Error removing document: ', error)
      mdui.snackbar({
          message: '帳户刪除失敗',
          position: 'bottom',
          timeout: 3000
      });
  })
      ReadLocationitemList();
      
}

// event for AlertDeleteBox for Location 
var deletelogLocation = document.getElementById('deletelogLocation');

deletelogLocation.addEventListener('open.mdui.dialog', function () {
  console.log('open');
});

deletelogLocation.addEventListener('opened.mdui.dialog', function () {
  console.log('opened');
});

deletelogLocation.addEventListener('close.mdui.dialog', function () {
  console.log('close');
});

deletelogLocation.addEventListener('closed.mdui.dialog', function () {
  console.log('closed');
});

deletelogLocation.addEventListener('cancel.mdui.dialog', function () {
  console.log('cancel');
});

deletelogLocation.addEventListener('confirm.mdui.dialog', function () {
  console.log('confirm');
});

// event for Login Box 
var Logindialog = document.getElementById('Logindialog');

Logindialog.addEventListener('open.mdui.dialog', function () {
  console.log('open');
});

Logindialog.addEventListener('opened.mdui.dialog', function () {
  console.log('opened');
});

Logindialog.addEventListener('close.mdui.dialog', function () {
  console.log('close');
  firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
      }else {
        ShowLoginAlert();
        login();
        };
    });
});

Logindialog.addEventListener('closed.mdui.dialog', function () {
  console.log('closed');
});

Logindialog.addEventListener('cancel.mdui.dialog', function () {
  console.log('cancel');
});

Logindialog.addEventListener('confirm.mdui.dialog', function () {
  console.log('confirm');
});

  </script>

  </body>
</html>
